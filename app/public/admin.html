<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Meta CAPI Gateway · Admin</title>
    <link rel="stylesheet" href="/style.css" />
  </head>
  <body>
    <main>
      <header class="card">
        <h1>Admin Dashboard</h1>
        <p class="helper">Developer-only tools for managing sites. Admin APIs require <code>X-Admin-Password</code>.</p>
      </header>

      <section class="card">
        <div class="section-title">
          <h2>Admin authentication</h2>
          <span class="status" id="auth-status">Not connected</span>
        </div>
        <div class="form-grid">
          <label>
            X-Admin-Password
            <input id="admin-password" type="password" placeholder="admin password" />
          </label>
          <div>
            <label>&nbsp;</label>
            <button id="save-password" type="button">Save &amp; load sites</button>
          </div>
        </div>
        <p class="helper">Password is stored only in your browser for this session.</p>
      </section>

      <section class="card">
        <div class="section-title">
          <h2>Configured sites</h2>
          <button class="secondary" id="refresh-sites" type="button">Refresh</button>
        </div>
        <table class="table" id="sites-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Pixel ID</th>
              <th>Site Key</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td colspan="4" class="helper">No data loaded yet.</td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="card">
        <h2>Add a new site</h2>
        <form id="site-form" class="form-grid">
          <label>Name<input name="name" required /></label>
          <label>Pixel ID<input name="pixel_id" /></label>
          <label>Access token<input name="access_token" /></label>
          <label>Test event code<input name="test_event_code" /></label>
          <label class="checkbox-row">
            <input type="checkbox" name="send_to_meta" />
            <span>Send to Meta</span>
            <span class="info-icon" title="When enabled, events are forwarded to Meta Conversions API.">i</span>
          </label>
          <label class="checkbox-row">
            <input type="checkbox" name="dry_run" checked />
            <span>Dry-run only</span>
            <span class="info-icon" title="Validate payloads without sending them to Meta.">i</span>
          </label>
          <label class="checkbox-row">
            <input type="checkbox" name="log_full_payloads" checked />
            <span>Log full payloads</span>
            <span class="info-icon" title="Store full event bodies to help diagnose issues.">i</span>
          </label>
          <div><label>&nbsp;</label><button type="submit">Create site</button></div>
        </form>
        <p class="helper">Endpoint: <code>POST /admin/sites</code></p>
      </section>

      <section class="card">
        <h2>Example curl</h2>
        <pre>curl -H "X-Admin-Password: &lt;admin_password&gt;" http://localhost:3000/admin/sites
curl -X POST http://localhost:3000/admin/sites \
  -H "content-type: application/json" \
  -H "X-Admin-Password: &lt;admin_password&gt;" \
  -d '{"name":"My Store","pixel_id":"123","access_token":"token"}'</pre>
        <p class="helper">Need logs? Try <code>GET /admin/logs</code> with the same header.</p>
      </section>
    </main>

    <script>
      const passwordInput = document.getElementById("admin-password");
      const authStatus = document.getElementById("auth-status");
      const sitesTableBody = document.querySelector("#sites-table tbody");
      const refreshButton = document.getElementById("refresh-sites");
      const saveButton = document.getElementById("save-password");
      const siteForm = document.getElementById("site-form");

      function getPassword() {
        return passwordInput.value.trim();
      }

      function setStatus(message, statusClass) {
        authStatus.textContent = message;
        authStatus.className = `status ${statusClass || ""}`.trim();
      }

      function headers() {
        const password = getPassword();
        return password ? { "X-Admin-Password": password } : {};
      }

      function renderSites(sites) {
        if (!sites.length) {
          sitesTableBody.innerHTML = '<tr><td colspan="4" class="helper">No sites configured.</td></tr>';
          return;
        }
        sitesTableBody.innerHTML = sites
          .map(site => `
            <tr>
              <td>${site.name || "Untitled"}</td>
              <td><span class="badge badge-${site.status || "unknown"}">${(site.status || "unknown").replace("_", " ")}</span></td>
              <td>${site.pixel_id || "—"}</td>
              <td><code>${site.site_key || "—"}</code></td>
            </tr>
          `)
          .join("");
      }

      async function loadSites() {
        setStatus("Loading…");
        try {
          const response = await fetch("/admin/sites", { headers: headers() });
          if (!response.ok) {
            setStatus("Unauthorized", "error");
            return;
          }
          const sites = await response.json();
          renderSites(sites);
          setStatus("Connected", "ok");
        } catch {
          setStatus("Connection failed", "error");
        }
      }

      async function createSite(event) {
        event.preventDefault();
        const formData = new FormData(siteForm);
        const payload = Object.fromEntries(formData.entries());
        payload.send_to_meta = formData.get("send_to_meta") === "on";
        payload.dry_run = formData.get("dry_run") === "on";
        payload.log_full_payloads = formData.get("log_full_payloads") === "on";

        try {
          const response = await fetch("/admin/sites", {
            method: "POST",
            headers: { "content-type": "application/json", ...headers() },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const data = await response.json().catch(() => ({}));
            setStatus(data.error || "Failed to create site", "error");
            return;
          }

          siteForm.reset();
          setStatus("Site created", "ok");
          await loadSites();
        } catch {
          setStatus("Request failed", "error");
        }
      }

      saveButton.addEventListener("click", () => {
        localStorage.setItem("meta-capi-admin-password", getPassword());
        loadSites();
      });
      refreshButton.addEventListener("click", loadSites);
      siteForm.addEventListener("submit", createSite);

      const savedPassword = localStorage.getItem("meta-capi-admin-password");
      if (savedPassword) {
        passwordInput.value = savedPassword;
        loadSites();
      }
    </script>
  </body>
</html>
